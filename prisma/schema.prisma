// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String   @id @default(cuid())
  email               String   @unique
  password_hash       String
  user_type           UserType
  first_name          String?
  last_name           String?
  profile_picture_url String?
  phone               String?
  is_verified         Boolean  @default(false)
  email_verified_at   DateTime?
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt
  deleted_at          DateTime?

  // Relations
  seniman_profile SenimanProfile?
  klien_profile   KlienProfile?
  reviews_given   Review[]       @relation("ReviewGiven")
  reviews_received Review[]      @relation("ReviewReceived")
  messages_sent   Message[]      @relation("MessageSent")
  messages_received Message[]    @relation("MessageReceived")
  notifications   Notification[]
  admin_logs      AdminLog[]

  @@map("users")
}

model SenimanProfile {
  id                      String              @id @default(cuid())
  user_id                 String              @unique
  bio                     String?
  lokasi                  String?
  kategori                String?             // JSON string array
  rate_per_hour           Decimal?
  rate_per_project        Decimal?
  rating_average          Decimal?            @default(0)
  total_reviews           Int                 @default(0)
  total_projects_completed Int                 @default(0)
  response_time_hours     Int?
  portfolio_count         Int                 @default(0)
  years_experience        Int?
  availability_status     AvailabilityStatus  @default(AVAILABLE)
  verification_status     VerificationStatus  @default(UNVERIFIED)
  is_featured             Boolean             @default(false)
  created_at              DateTime            @default(now())
  updated_at              DateTime            @updatedAt

  // Relations
  user              User             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  portfolio_items   PortfolioItem[]
  project_proposals ProjectProposal[]
  projects          Project[]        @relation("SenimanProjects")
  reviews_received  Review[]         @relation("SenimanReviews")
  transactions      Transaction[]    @relation("SenimanTransactions")
  messages_sent     Message[]        @relation("SenimanSent")
  messages_received Message[]        @relation("SenimanReceived")

  @@map("seniman_profiles")
}

model KlienProfile {
  id                      String       @id @default(cuid())
  user_id                 String       @unique
  company_name            String?
  company_description     String?
  company_website         String?
  company_size            CompanySize? @default(PERSONAL)
  industry                String?
  total_projects_posted   Int          @default(0)
  total_spent             Decimal?     @default(0)
  rating_as_buyer         Decimal?     @default(0)
  created_at              DateTime     @default(now())
  updated_at              DateTime     @updatedAt

  // Relations
  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  projects     Project[]     @relation("KlienProjects")
  reviews_given Review[]     @relation("KlienReviews")
  transactions Transaction[] @relation("KlienTransactions")
  messages_sent Message[]    @relation("KlienSent")
  messages_received Message[] @relation("KlienReceived")

  @@map("klien_profiles")
}

model PortfolioItem {
  id            String   @id @default(cuid())
  seniman_id    String
  title         String
  description   String?
  category      String?
  image_urls    String?  // JSON string array
  video_url     String?
  project_date  DateTime?
  client_name   String?
  tools_used    String?  // JSON string array
  is_featured   Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  seniman SenimanProfile @relation(fields: [seniman_id], references: [id], onDelete: Cascade)

  @@map("portfolio_items")
}

model Project {
  id                      String      @id @default(cuid())
  klien_id                String
  seniman_id              String?
  title                   String
  description             String
  category                String
  budget                  Decimal
  budget_type             BudgetType
  status                  ProjectStatus @default(DRAFT)
  start_date              DateTime?
  deadline                DateTime?
  estimated_duration_days Int?
  required_skills         String?     // JSON string array
  attachments             String?     // JSON string array
  klien_notes             String?
  created_at              DateTime    @default(now())
  updated_at              DateTime    @updatedAt
  completed_at            DateTime?

  // Relations
  klien         KlienProfile      @relation("KlienProjects", fields: [klien_id], references: [id], onDelete: Cascade)
  seniman       SenimanProfile?   @relation("SenimanProjects", fields: [seniman_id], references: [id], onDelete: SetNull)
  proposals     ProjectProposal[]
  transactions  Transaction[]
  reviews       Review[]         @relation("ProjectReviews")
  messages      Message[]        @relation("ProjectMessages")

  @@map("projects")
}

model ProjectProposal {
  id                    String            @id @default(cuid())
  project_id            String
  seniman_id            String
  proposed_budget       Decimal
  proposed_timeline_days Int?
  cover_letter          String?
  status                ProposalStatus    @default(PENDING)
  created_at            DateTime          @default(now())
  updated_at            DateTime          @updatedAt

  // Relations
  project Project         @relation(fields: [project_id], references: [id], onDelete: Cascade)
  seniman SenimanProfile @relation(fields: [seniman_id], references: [id], onDelete: Cascade)

  @@unique([project_id, seniman_id])
  @@map("project_proposals")
}

model Transaction {
  id                    String           @id @default(cuid())
  project_id            String
  klien_id              String
  seniman_id            String
  amount                Decimal
  currency              String           @default("IDR")
  payment_method        PaymentMethod
  payment_gateway       PaymentGateway
  gateway_transaction_id String?
  status                TransactionStatus @default(PENDING)
  escrow_status         EscrowStatus     @default(HELD)
  fee_percentage        Decimal          @default(10)
  platform_fee          Decimal
  net_amount            Decimal
  created_at            DateTime         @default(now())
  updated_at            DateTime         @updatedAt
  completed_at          DateTime?

  // Relations
  project Project        @relation(fields: [project_id], references: [id], onDelete: Cascade)
  klien   KlienProfile   @relation("KlienTransactions", fields: [klien_id], references: [id], onDelete: Cascade)
  seniman SenimanProfile @relation("SenimanTransactions", fields: [seniman_id], references: [id], onDelete: Cascade)

  @@map("transactions")
}
model Review {
  id               String    @id @default(cuid())
  project_id       String
  reviewer_id      String
  reviewee_id      String
  reviewer_type    ReviewerType
  rating           Int
  comment          String?
  professionalism  Int?
  quality_of_work  Int?
  communication    Int?
  timeliness       Int?
  would_hire_again Boolean?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  // Relations
  project  Project         @relation("ProjectReviews", fields: [project_id], references: [id], onDelete: Cascade)
  
  // FIX untuk konflik 'reviewer_id'
  reviewer User            @relation("ReviewGiven", fields: [reviewer_id], references: [id], onDelete: Cascade, map: "reviews_reviewer_user_fkey")
  klien    KlienProfile?   @relation("KlienReviews", fields: [reviewer_id], references: [user_id], onDelete: Cascade, map: "reviews_reviewer_klien_fkey")

  // FIX untuk konflik 'reviewee_id'
  reviewee User            @relation("ReviewReceived", fields: [reviewee_id], references: [id], onDelete: Cascade, map: "reviews_reviewee_user_fkey")
  seniman  SenimanProfile? @relation("SenimanReviews", fields: [reviewee_id], references: [user_id], onDelete: Cascade, map: "reviews_reviewee_seniman_fkey")


  @@unique([project_id, reviewer_id])
  @@map("reviews")
}

model Message {
  id              String    @id @default(cuid())
  project_id      String?
  sender_id       String
  receiver_id     String
  message         String
  attachment_urls String? // JSON string array
  is_read         Boolean   @default(false)
  read_at         DateTime?
  created_at      DateTime  @default(now())

  // Relations
  project  Project?        @relation("ProjectMessages", fields: [project_id], references: [id], onDelete: SetNull)
  sender   User            @relation("MessageSent", fields: [sender_id], references: [id], onDelete: Cascade)
  receiver User            @relation("MessageReceived", fields: [receiver_id], references: [id], onDelete: Cascade)

  seniman  SenimanProfile? @relation("SenimanSent", fields: [sender_id], references: [user_id], onDelete: Cascade, map: "messages_sender_seniman_fkey")
  klien    KlienProfile?   @relation("KlienSent", fields: [sender_id], references: [user_id], onDelete: Cascade, map: "messages_sender_klien_fkey")

  seniman_receiver SenimanProfile? @relation("SenimanReceived", fields: [receiver_id], references: [user_id], onDelete: Cascade, map: "messages_receiver_seniman_fkey")
  klien_receiver   KlienProfile?   @relation("KlienReceived", fields: [receiver_id], references: [user_id], onDelete: Cascade, map: "messages_receiver_klien_fkey")

  @@map("messages")
}
model Notification {
  id          String           @id @default(cuid())
  user_id     String
  type        NotificationType
  title       String
  description String
  related_id  String?
  is_read     Boolean          @default(false)
  created_at  DateTime         @default(now())

  // Relations
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AdminLog {
  id          String   @id @default(cuid())
  admin_id    String
  action      String
  entity_type String
  entity_id   String
  old_values  String?  // JSON
  new_values  String?  // JSON
  created_at  DateTime @default(now())

  // Relations
  admin User @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@map("admin_logs")
}

// Enums
enum UserType {
  SENIMAN
  KLIEN
  ADMIN
}

enum AvailabilityStatus {
  AVAILABLE
  BUSY
  ON_BREAK
}

enum VerificationStatus {
  UNVERIFIED
  PENDING
  VERIFIED
}

enum CompanySize {
  PERSONAL
  STARTUP
  SMALL
  MEDIUM
  LARGE
}

enum BudgetType {
  FIXED
  HOURLY
}

enum ProjectStatus {
  DRAFT
  POSTED
  NEGOTIATING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ProposalStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  E_WALLET
}

enum PaymentGateway {
  STRIPE
  MIDTRANS
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
}

enum ReviewerType {
  KLIEN
  SENIMAN
}

enum NotificationType {
  PROJECT_INVITE
  PROPOSAL_ACCEPTED
  PAYMENT_RECEIVED
  REVIEW_POSTED
  MESSAGE_RECEIVED
  PROJECT_UPDATE
}